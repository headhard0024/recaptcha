<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>reCAPTCHA v2</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: sans-serif;
      direction: rtl;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #333333;
    }
    #recaptcha-container {
      display: inline-block;
    }
  </style>
</head>
<body>

  <div id="recaptcha-container"></div>

  <script>
    // تابع برای خواندن sitekey از query parameter
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || urlParams.get('k');
    }

    const siteKey = getUrlParameter('sitekey') || '6Lf5m1MrAAAAAGCPtMqKrKJDyvWZPn93XSSk_ylx';

    let captchaToken = null;

    // وقتی reCAPTCHA با موفقیت تأیید شد
    function onCaptchaSuccess(token) {
      captchaToken = token;
      console.log('✅ reCAPTCHA solved. Token:', token);

      // ✅ همیشه به parent ارسال کن — چه در WebView باشه، چه در Web
      window.parent.postMessage(JSON.stringify({
        action: 'recaptcha-success',
        token: token
      }), '*');

      // ✅ اگر در WebView باشه و RecaptchaChannel وجود داشت — اون رو هم صدا بزن (برای پشتیبانی قدیمی)
      if (typeof RecaptchaChannel !== 'undefined' && RecaptchaChannel.postMessage) {
        RecaptchaChannel.postMessage(JSON.stringify({
          action: 'recaptcha-success',
          token: token
        }));
      }
    }

    // تنظیم reCAPTCHA
    function renderCaptcha() {
      grecaptcha.render('recaptcha-container', {
        'sitekey': siteKey,
        'callback': onCaptchaSuccess
      });
    }

    // ارسال توکن به Flutter در صورت درخواست
    function sendToken() {
      if (captchaToken) {
        window.parent.postMessage(JSON.stringify({
          action: 'recaptcha-token',
          token: captchaToken
        }), '*');
      } else {
        window.parent.postMessage(JSON.stringify({
          action: 'recaptcha-empty'
        }), '*');
      }
    }

    // پذیرش پیام از Flutter
    window.addEventListener('message', function(event) {
      if (event.data && typeof event.data === 'string') {
        try {
          const data = JSON.parse(event.data);
          if (data.action === 'get-token') {
            sendToken();
          } else if (data.action === 'reset') {
            grecaptcha.reset();
            captchaToken = null;
          }
        } catch (e) {
          console.warn('Invalid JSON received:', event.data);
        }
      }
    });

    // ارسال پیام آماده‌بودن
    window.addEventListener('load', function() {
      setTimeout(() => {
        window.parent.postMessage(JSON.stringify({ action: 'recaptcha-ready' }), '*');
      }, 500);
      renderCaptcha();
    });
  </script>
</body>
</html>
