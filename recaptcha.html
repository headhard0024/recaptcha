<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>reCAPTCHA v2</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: sans-serif;
      direction: rtl;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #ffffffff;
    }
    #recaptcha-container {
      display: inline-block;
    }
  </style>
</head>
<body>

  <div id="recaptcha-container"></div>

  <script>
    // تابع برای خواندن sitekey از query parameter
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || urlParams.get('k'); // می‌تونی با ?sitekey=... یا ?k=... بفرستی
    }

    const siteKey = getUrlParameter('sitekey') || '6Lf5m1MrAAAAAGCPtMqKrKJDyvWZPn93XSSk_ylx'; // پیش‌فرض اختیاری

    // متغیر برای نگه‌داری توکن
    let captchaToken = null;

    // تنظیم reCAPTCHA
    function renderCaptcha() {
      grecaptcha.render('recaptcha-container', {
        'sitekey': siteKey,
        'callback': onCaptchaSuccess
      });
    }

    // وقتی reCAPTCHA با موفقیت تأیید شد
    function onCaptchaSuccess(token) {
      captchaToken = token;
    
      // بررسی وجود RecaptchaChannel در محیط Flutter WebView
      if (typeof RecaptchaChannel !== 'undefined') {
        RecaptchaChannel.postMessage(JSON.stringify({
          action: 'recaptcha-success',
          token: token
        }));
      } else {
        // برای تست در مرورگر (اختیاری)
        console.log('Token (در مرورگر):', token);
      }
    }

    // اگر کاربر کپچا رو ریست کنه
    function onCaptchaExpired() {
      window.parent.postMessage({
        action: 'recaptcha-expired'
      }, '*');
    }

    // ارسال توکن به Flutter در صورت درخواست (مثلاً وقتی کنترلر چک می‌کنه)
    function sendToken() {
      if (captchaToken) {
        window.parent.postMessage({
          action: 'recaptcha-token',
          token: captchaToken
        }, '*');
      } else {
        window.parent.postMessage({
          action: 'recaptcha-empty'
        }, '*');
      }
    }

    // پذیرش پیام از Flutter
    window.addEventListener('message', function(event) {
      // می‌تونی بر اساس event.origin امنیت رو افزایش بدی
      if (event.data && event.data.action === 'get-token') {
        sendToken();
      } else if (event.data && event.data.action === 'reset') {
        grecaptcha.reset();
        captchaToken = null;
      }
    });

    // ارسال پیام آماده‌بودن به Flutter
    window.onload = function() {
      // اطمینان از اینکه reCAPTCHA آماده شد
      setTimeout(() => {
        window.parent.postMessage({ action: 'recaptcha-ready' }, '*');
      }, 1000);
    };

    // رندر کپچا وقتی api بارگذاری شد
    window.onload = renderCaptcha;
  </script>
</body>
</html>
